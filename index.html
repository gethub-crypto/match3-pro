<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Match3 Optimized</title>

<style>
body{
margin:0;
background:#0f172a;
font-family:Arial;
color:white;
overflow:hidden;
}

.screen{
display:none;
width:100vw;
height:100vh;
flex-direction:column;
align-items:center;
justify-content:center;
}

button{
padding:12px 24px;
font-size:16px;
border:none;
border-radius:10px;
background:#2563eb;
color:white;
margin:10px;
}

canvas{
background:#0b1220;
border-radius:15px;
}

#menu{display:flex;}
</style>
</head>
<body>

<div id="menu" class="screen">
<h1>Match 3</h1>
<button onclick="startGame()">Start</button>
</div>

<div id="game" class="screen">
<canvas id="canvas" width="480" height="480"></canvas>
<div>
<button onclick="pauseGame()">Pause</button>
<span id="score">Score: 0</span>
</div>
</div>

<div id="pause" class="screen">
<h2>Paused</h2>
<button onclick="resumeGame()">Resume</button>
<button onclick="backMenu()">Menu</button>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const rows=8, cols=8, size=60;
const colors=["#ff4d6d","#ffd60a","#2ec4b6","#3a86ff","#9d4edd","#fb5607"];

let grid=[];
let selected=null;
let score=0;
let running=false;
let lastTime=0;

function show(id){
document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
document.getElementById(id).style.display="flex";
}

function randColor(){
return colors[Math.floor(Math.random()*colors.length)];
}

function init(){
grid=[];
for(let r=0;r<rows;r++){
let row=[];
for(let c=0;c<cols;c++){
row.push({color:randColor(),offset:0});
}
grid.push(row);
}
}

function draw(){
ctx.clearRect(0,0,480,480);

for(let r=0;r<rows;r++){
for(let c=0;c<cols;c++){
let cell=grid[r][c];
if(!cell) continue;

let x=c*size;
let y=r*size+cell.offset;

ctx.fillStyle=cell.color;
ctx.beginPath();
ctx.arc(x+30,y+30,25,0,Math.PI*2);
ctx.fill();

if(selected && selected.r==r && selected.c==c){
ctx.strokeStyle="#fff";
ctx.lineWidth=3;
ctx.stroke();
}
}
}
}

function swap(a,b){
let temp=grid[a.r][a.c];
grid[a.r][a.c]=grid[b.r][b.c];
grid[b.r][b.c]=temp;
}

function checkMatches(){
let matches=new Set();

for(let r=0;r<rows;r++){
for(let c=0;c<cols-2;c++){
let a=grid[r][c];
let b=grid[r][c+1];
let d=grid[r][c+2];
if(a && b && d && a.color===b.color && a.color===d.color){
matches.add(r+","+c);
matches.add(r+","+(c+1));
matches.add(r+","+(c+2));
}
}
}

for(let c=0;c<cols;c++){
for(let r=0;r<rows-2;r++){
let a=grid[r][c];
let b=grid[r+1][c];
let d=grid[r+2][c];
if(a && b && d && a.color===b.color && a.color===d.color){
matches.add(r+","+c);
matches.add((r+1)+","+c);
matches.add((r+2)+","+c);
}
}
}

return matches;
}

function removeMatches(matches){
matches.forEach(str=>{
let [r,c]=str.split(",").map(Number);
grid[r][c]=null;
});
score+=matches.size*5;
document.getElementById("score").innerText="Score: "+score;
}

function collapse(){
for(let c=0;c<cols;c++){
let empty=0;
for(let r=rows-1;r>=0;r--){
if(!grid[r][c]){
empty++;
}else if(empty>0){
grid[r+empty][c]=grid[r][c];
grid[r][c]=null;
}
}
for(let i=0;i<empty;i++){
grid[i][c]={color:randColor(),offset:-size};
}
}
}

function update(delta){
for(let r=0;r<rows;r++){
for(let c=0;c<cols;c++){
let cell=grid[r][c];
if(cell && cell.offset<0){
cell.offset+=delta*0.5;
if(cell.offset>0) cell.offset=0;
}
}
}
}

function loop(timestamp){
if(!running) return;

let delta=timestamp-lastTime;
lastTime=timestamp;

update(delta);
draw();

requestAnimationFrame(loop);
}

canvas.addEventListener("click",e=>{
if(!running) return;

let rect=canvas.getBoundingClientRect();
let c=Math.floor((e.clientX-rect.left)/size);
let r=Math.floor((e.clientY-rect.top)/size);

if(!selected){
selected={r,c};
}else{
if(Math.abs(selected.r-r)+Math.abs(selected.c-c)==1){
swap(selected,{r,c});
let matches=checkMatches();
if(matches.size>0){
removeMatches(matches);
collapse();
}
}
selected=null;
}
});

function startGame(){
score=0;
init();
running=true;
show("game");
requestAnimationFrame(loop);
}

function pauseGame(){
running=false;
show("pause");
}

function resumeGame(){
running=true;
show("game");
requestAnimationFrame(loop);
}

function backMenu(){
running=false;
show("menu");
}
</script>
</body>
</html>
